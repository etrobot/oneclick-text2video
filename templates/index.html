<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本生成视频</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- 左侧编辑器 -->
            <div class="bg-white p-6 rounded-none shadow-lg">
                <h2 class="text-2xl font-bold mb-4">文本编辑器</h2>
                <div class="mb-4">
                    <textarea
                        id="script"
                        name="script"
                        class="w-full h-48 p-4 border rounded-none"
                        placeholder="请输入文本..."
                    ></textarea>
                </div>
                <div class="flex gap-4 mb-4">
                    <button
                        class="bg-blue-500 text-white px-6 py-2 rounded-none hover:bg-blue-600"
                        hx-post="/generate-video"
                        hx-trigger="click"
                        hx-include="#script"
                        hx-indicator="#spinner"
                    >
                        生成视频
                    </button>
                </div>
                <div id="spinner" class="htmx-indicator">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                </div>
            </div>

            <!-- 右侧预览 -->
            <div class="bg-white p-6 rounded-none shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold">视频预览</h2>
                    <div class="flex gap-4">
                        <select 
                            id="task-selector" 
                            class="p-2 border rounded-none"
                            onchange="loadTaskVideos(this.value)"
                        >
                            <option value="">选择任务ID</option>
                            {% for task_id in task_ids %}
                                <option value="{{ task_id }}">{{ task_id }}</option>
                            {% endfor %}
                        </select>
                        <button
                            id="delete-task-btn"
                            class="bg-red-500 text-white px-4 py-2 rounded-none hover:bg-red-600 hidden"
                            onclick="deleteTask()"
                        >
                            删除任务
                        </button>
                    </div>
                </div>
                
                <div id="video-preview" class="mb-8">
                    <div class="text-gray-500 text-center py-8">
                        请选择一个任务ID查看视频。
                    </div>
                </div>

                <h3 class="text-xl font-bold mb-4">视频片段</h3>
                <div id="video-grid" class="video-grid">
                    <!-- 视频缩略图将通过JavaScript动态加载 -->
                </div>

                <div id="merge-container" class="mt-8 hidden">
                    <button
                        class="bg-green-500 text-white px-6 py-2 rounded-none hover:bg-green-600"
                        hx-post="/merge-videos"
                        hx-trigger="click"
                        hx-indicator="#merge-spinner"
                    >
                        合并所有视频
                    </button>
                    <div id="merge-spinner" class="htmx-indicator">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知区域 -->
    <div id="notifications" class="fixed bottom-4 right-4"></div>

    <script>
        let currentTaskId = null;

        async function loadTaskVideos(taskId) {
            if (!taskId) {
                document.getElementById('video-preview').innerHTML = '<div class="text-gray-500 text-center py-8">请选择一个任务ID查看视频。</div>';
                document.getElementById('video-grid').innerHTML = '';
                document.getElementById('delete-task-btn').classList.add('hidden');
                document.getElementById('merge-container').classList.add('hidden');
                currentTaskId = null;
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}/videos`);
                const data = await response.json();
                currentTaskId = taskId;
                
                // 显示删除按钮
                document.getElementById('delete-task-btn').classList.remove('hidden');

                if (data.videos && data.videos.length > 0) {
                    // 更新主视频预览
                    document.getElementById('video-preview').innerHTML = `
                        <video id="current-video" controls class="w-full rounded-none shadow">
                            <source src="${data.videos[0].video_url}" type="video/mp4">
                            您的浏览器不支持视频播放。
                        </video>
                    `;

                    // 更新视频网格
                    document.getElementById('video-grid').innerHTML = data.videos.map((video, index) => `
                        <div class="video-thumbnail">
                            <img
                                src="${video.thumbnail_url}"
                                alt="视频缩略图"
                                class="w-full h-32 object-cover rounded cursor-pointer"
                                onclick="document.getElementById('current-video').src = '${video.video_url}'"
                            >
                            <p class="text-sm text-gray-600 mt-1">片段 ${index + 1}</p>
                        </div>
                    `).join('');

                    // 显示合并按钮
                    document.getElementById('merge-container').classList.remove('hidden');
                } else {
                    document.getElementById('video-preview').innerHTML = '<div class="text-gray-500 text-center py-8">该任务没有可用的视频。</div>';
                    document.getElementById('video-grid').innerHTML = '';
                    document.getElementById('merge-container').classList.add('hidden');
                }
            } catch (error) {
                showNotification('加载视频失败', 'error');
            }
        }

        async function deleteTask() {
            if (!currentTaskId) return;
            
            if (!confirm(`确定要删除任务 ${currentTaskId} 及其所有相关文件吗？`)) return;

            try {
                const response = await fetch(`/api/tasks/${currentTaskId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (response.ok) {
                    showNotification(data.message, 'success');
                    // 重新加载页面以更新任务列表
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('删除任务失败', 'error');
            }
        }

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            const response = evt.detail.xhr.response;
            if (response) {
                try {
                    const data = JSON.parse(response);
                    if (data.message) {
                        showNotification(data.message, 'success');
                        // 如果生成了新视频，刷新页面
                        if (data.task_id || data.video_path) {
                            setTimeout(() => location.reload(), 1000);
                        }
                    } else if (data.error) {
                        showNotification(data.error, 'error');
                    }
                } catch (e) {
                    // 响应可能不是JSON格式
                }
            }
        });

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-none shadow-lg mb-2 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            notification.textContent = message;
            
            const notifications = document.getElementById('notifications');
            notifications.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html> 